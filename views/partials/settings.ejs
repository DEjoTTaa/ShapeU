<div class="settings-backdrop hidden" id="settings-backdrop" onclick="toggleSettings()"></div>
<div class="settings-panel hidden" id="settings-panel">
  <div class="settings-header">
    <h2>ConfiguraÃ§Ãµes</h2>
    <button class="close-btn" onclick="toggleSettings()">âœ•</button>
  </div>

  <div class="settings-content">
    <section class="settings-section">
      <h3>Avatar</h3>
      <div class="current-avatar" id="settings-avatar">
        <% if (user.avatar && user.avatar.type === 'custom') { %>
          <img src="<%= user.avatar.value %>" alt="Avatar" class="settings-avatar-img" />
        <% } else { %>
          <span class="settings-avatar-emoji"><%= (user.avatar && user.avatar.value) || 'ğŸ˜€' %></span>
        <% } %>
      </div>
      <button class="upload-btn" id="open-avatar-modal-btn" type="button">ğŸ“· Upload Imagem</button>
      <div class="avatar-grid" id="predefined-avatars">
        <% const emojis = ['ğŸ˜€','ğŸ˜','ğŸ¦Š','ğŸº','ğŸ¦','ğŸ¯','ğŸ»','ğŸ¼','ğŸ¦…','ğŸ‰']; %>
        <% emojis.forEach(e => { %>
          <span class="avatar-option <%= (user.avatar && user.avatar.value === e) ? 'selected' : '' %>" data-type="predefined" data-value="<%= e %>"><%= e %></span>
        <% }); %>
      </div>
      <h4>DesbloqueÃ¡veis</h4>
      <div class="avatar-grid" id="unlockable-avatars">
        <% unlockableAvatars.forEach(a => { %>
          <span class="avatar-option <%= user.level >= a.level ? '' : 'locked' %>"
                data-type="unlockable" data-value="<%= a.emoji %>" data-level="<%= a.level %>"
                title="<%= user.level >= a.level ? a.emoji : 'NÃ­vel ' + a.level %>">
            <%= user.level >= a.level ? a.emoji : 'ğŸ”’' %>
            <% if (user.level < a.level) { %><small>Nv<%= a.level %></small><% } %>
          </span>
        <% }); %>
      </div>
    </section>

    <section class="settings-section">
      <h3>Perfil</h3>
      <div class="profile-info">
        <span class="profile-username">@<%= user.username %></span>
        <span class="profile-level">NÃ­vel <%= user.level %> â€” <%= user.title %></span>
      </div>
      <button class="btn btn-ghost" onclick="openPasswordModal()">Alterar Senha</button>
    </section>

    <section class="settings-section">
      <h3>PersonalizaÃ§Ã£o</h3>
      <div class="theme-grid" id="theme-grid">
        <div class="theme-circle <%= user.theme === 'dourado' ? 'selected' : '' %>" data-theme="dourado" style="background:#D4AF37" title="Dourado ClÃ¡ssico"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'azul-royal' ? 'selected' : '' %>" data-theme="azul-royal" style="background:#2196F3" title="Azul Royal"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'verde-esmeralda' ? 'selected' : '' %>" data-theme="verde-esmeralda" style="background:#00E676" title="Verde Esmeralda"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'rosa-neon' ? 'selected' : '' %>" data-theme="rosa-neon" style="background:#E91E63" title="Rosa Neon"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'roxo-imperial' ? 'selected' : '' %>" data-theme="roxo-imperial" style="background:#9C27B0" title="Roxo Imperial"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'laranja-fogo' ? 'selected' : '' %>" data-theme="laranja-fogo" style="background:#FF5722" title="Laranja Fogo"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'ciano-eletrico' ? 'selected' : '' %>" data-theme="ciano-eletrico" style="background:#00BCD4" title="Ciano ElÃ©trico"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'vermelho-rubi' ? 'selected' : '' %>" data-theme="vermelho-rubi" style="background:#F44336" title="Vermelho Rubi"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'ambar' ? 'selected' : '' %>" data-theme="ambar" style="background:#FFC107" title="Ã‚mbar"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'indigo' ? 'selected' : '' %>" data-theme="indigo" style="background:#3F51B5" title="Ãndigo"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'teal' ? 'selected' : '' %>" data-theme="teal" style="background:#009688" title="Teal"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'lima' ? 'selected' : '' %>" data-theme="lima" style="background:#CDDC39" title="Lima"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'coral' ? 'selected' : '' %>" data-theme="coral" style="background:#FF7043" title="Coral"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'lavanda' ? 'selected' : '' %>" data-theme="lavanda" style="background:#7E57C2" title="Lavanda"><span class="theme-check">âœ“</span></div>
        <div class="theme-circle <%= user.theme === 'prata' ? 'selected' : '' %>" data-theme="prata" style="background:#9E9E9E" title="Prata"><span class="theme-check">âœ“</span></div>
      </div>
    </section>

    <section class="settings-section">
      <h3>Gerenciar Metas</h3>
      <button class="btn btn-ghost full-width" onclick="openManageGoals()">Gerenciar Metas â†’</button>
    </section>

    <section class="settings-section">
      <h3>Dados</h3>
      <label class="btn btn-ghost full-width" style="margin-bottom:8px;cursor:pointer">
        ğŸ“¤ Importar Dados
        <input type="file" id="import-data" accept=".json" hidden />
      </label>
      <a href="/api/profile/export" class="btn btn-ghost full-width" style="margin-bottom:8px">ğŸ“¥ Exportar Dados</a>
      <button class="btn btn-danger full-width" onclick="openDeleteAccount()">ğŸ—‘ï¸ Apagar Conta</button>
    </section>

    <section class="settings-section about">
      <p>ShapeU v2.0</p>
      <p class="tagline">Molde o seu futuro</p>
      <p>Feito por DEjoTTaa â¤ï¸</p>
    </section>

    <div class="settings-section">
      <a href="/logout" class="btn btn-ghost full-width">Sair</a>
    </div>
  </div>
</div>

<!-- Avatar Preview Modal -->
<div class="modal-overlay hidden" id="avatar-preview-modal">
  <div class="modal-card" style="max-width:400px">
    <h2 class="modal-title gold-text">Alterar Avatar</h2>
    <div class="avatar-preview-container">
      <div class="avatar-preview-circle" id="avatar-preview-circle">
        <span style="font-size:48px;color:var(--text-secondary)">ğŸ“·</span>
      </div>
    </div>
    <label class="btn btn-ghost full-width" style="margin-bottom:12px;cursor:pointer" id="avatar-file-label">
      Selecionar Imagem
      <input type="file" id="avatar-upload" accept="image/jpeg,image/png,image/gif,image/webp" hidden />
    </label>
    <div class="avatar-file-info hidden" id="avatar-file-info">
      <span id="avatar-file-name"></span>
      <span id="avatar-file-size"></span>
    </div>
    <div class="avatar-file-error hidden" id="avatar-file-error"></div>
    <div class="modal-actions">
      <button type="button" class="btn btn-ghost" onclick="closeAvatarModal()">Cancelar</button>
      <button type="button" class="btn btn-primary" id="save-avatar-btn" disabled onclick="saveAvatarFromModal()">Salvar Avatar</button>
    </div>
  </div>
</div>

<div class="modal-overlay hidden" id="password-modal">
  <div class="modal-card">
    <h2 class="modal-title">Alterar Senha</h2>
    <form id="password-form">
      <div class="form-group">
        <label>Senha atual</label>
        <input type="password" id="current-password" required />
      </div>
      <div class="form-group">
        <label>Nova senha</label>
        <input type="password" id="new-password" required minlength="6" />
      </div>
      <div class="form-group">
        <label>Confirmar nova senha</label>
        <input type="password" id="confirm-password" required minlength="6" />
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-ghost" onclick="closePasswordModal()">Cancelar</button>
        <button type="submit" class="btn btn-primary">Salvar</button>
      </div>
    </form>
  </div>
</div>

<div class="modal-overlay hidden" id="manage-goals-modal">
  <div class="modal-card modal-wide">
    <h2 class="modal-title gold-text">Gerenciar Metas</h2>
    <div id="manage-goals-list"></div>
    <button class="add-goal-btn" onclick="closeManageGoals(); openGoalModal();">+ Nova Meta</button>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeManageGoals()">Fechar</button>
    </div>
  </div>
</div>

<div class="modal-overlay hidden" id="delete-account-modal">
  <div class="modal-card">
    <h2 class="modal-title" style="color: #FF5252">Apagar Conta</h2>
    <p style="color: var(--text-secondary); margin-bottom: 16px;">Esta aÃ§Ã£o Ã© irreversÃ­vel. Digite seu username para confirmar:</p>
    <form id="delete-account-form">
      <div class="form-group">
        <input type="text" id="confirm-username" placeholder="Username" required />
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-ghost" onclick="closeDeleteAccount()">Cancelar</button>
        <button type="submit" class="btn btn-danger">Apagar Permanentemente</button>
      </div>
    </form>
  </div>
</div>

<div class="modal-overlay hidden" id="import-confirm-modal">
  <div class="modal-card">
    <h2 class="modal-title" style="color: var(--neutral)">ğŸ“¤ Importar Dados</h2>
    <p style="color: var(--text-secondary); margin-bottom: 16px;">Isso vai substituir todos os seus dados atuais (metas, logs e conquistas). Deseja continuar?</p>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="cancelImport()">Cancelar</button>
      <button class="btn btn-primary" onclick="confirmImport()">Sim, Importar</button>
    </div>
  </div>
</div>
